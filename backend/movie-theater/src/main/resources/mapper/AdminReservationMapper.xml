<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.my.movietheater.reservation.mapper.AdminReservationMapper">

  <sql id="joinBase">
    FROM reservation r
    LEFT JOIN users u    ON u.user_id = r.user_id
    LEFT JOIN room rm    ON rm.room_id = r.room_id
    LEFT JOIN schedule s ON s.schedule_id = r.schedule_id
  </sql>

  <sql id="whereBase">
    WHERE s.display_date = #{date}

    <if test="status != null">
      AND r.status = #{status}
    </if>

    <if test="keyword != null">
      AND (
        r.reservation_no LIKE CONCAT('%', #{keyword}, '%')
        OR u.name  LIKE CONCAT('%', #{keyword}, '%')
        OR u.email LIKE CONCAT('%', #{keyword}, '%')
        OR u.phone LIKE CONCAT('%', #{keyword}, '%')
      )
    </if>
  </sql>

  <select id="selectAdminReservationList"
          resultType="com.my.movietheater.reservation.dto.AdminReservationListDto">
    SELECT
      r.reservation_id AS reservationId,
      r.reservation_no AS reservationNo,
      r.people_count   AS peopleCount,
      r.price_total    AS priceTotal,
      r.status         AS reservationStatus,

      u.name           AS userName,
      u.email          AS userEmail,
      u.phone          AS userPhone,

      rm.room_name     AS roomName,

      s.display_date   AS displayDate,
      s.start_at       AS startAt,
      s.end_at         AS endAt

    <include refid="joinBase"/>
    <include refid="whereBase"/>

    ORDER BY r.created_at DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countAdminReservationList" resultType="int">
    SELECT COUNT(*)
    <include refid="joinBase"/>
    <include refid="whereBase"/>
  </select>

  <select id="selectReservationStatusById" resultType="string">
    SELECT status
    FROM reservation
    WHERE reservation_id = #{reservationId}
  </select>

  <update id="cancelReservationByAdmin">
    UPDATE reservation
    SET status = 'CANCELLED',
        canceled_at = NOW(),
        updated_at = NOW()
    WHERE reservation_id = #{reservationId}
      AND status != 'CANCELLED'
  </update>

</mapper>
